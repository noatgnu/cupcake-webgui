<div class="async-task-dropdown">
  <button
    #toggleButton
    [class]="getButtonClass()"
    (click)="toggleDropdown()"
    type="button"
    [title]="'Active tasks: ' + activeCount()">
    <i class="bi bi-list-task fs-5"></i>
    @if (activeCount() > 0) {
      <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
        {{ activeCount() > 99 ? '99+' : activeCount() }}
      </span>
    }
  </button>

  @if (isOpen()) {
    <div
      class="dropdown-menu show"
      [style.bottom.px]="dropdownPosition().bottom"
      [style.left.px]="dropdownPosition().left"
      style="width: 400px; max-height: 500px;">
      <div class="dropdown-header d-flex justify-content-between align-items-center">
        <h6 class="mb-0">
          <i class="bi bi-list-task me-2"></i>
          Recent Tasks
        </h6>
        <button type="button" class="btn-close btn-sm" (click)="closeDropdown()"></button>
      </div>

      @if (recentTasks().length === 0) {
        <div class="text-center p-4 text-muted">
          <i class="bi bi-inbox fs-1 mb-2 d-block"></i>
          <p class="mb-0">No recent tasks</p>
        </div>
      } @else {
        <div class="tasks-list" style="max-height: 400px; overflow-y: auto;">
          @for (task of recentTasks(); track task.id) {
            <div class="dropdown-item task-item" [class.has-download]="task.result?.download_url">
              <div class="d-flex flex-column gap-2">
                <div class="d-flex justify-content-between align-items-start">
                  <div class="flex-grow-1 overflow-hidden">
                    <div class="fw-semibold">{{ getTaskDisplayName(task) }}</div>
                    @if (task.metadataTableName) {
                      <small class="text-muted d-block text-truncate">{{ task.metadataTableName }}</small>
                    }
                    @if (task.status === TaskStatus.SUCCESS) {
                      <small class="text-success">
                        <i class="bi bi-check-circle-fill me-1"></i>
                        Completed
                      </small>
                    } @else if (task.status === TaskStatus.FAILURE) {
                      <small class="text-danger">
                        <i class="bi bi-x-circle-fill me-1"></i>
                        Failed
                        @if (task.errorMessage) {
                          <span class="d-block">{{ task.errorMessage }}</span>
                        }
                      </small>
                    } @else if (task.status === TaskStatus.CANCELLED) {
                      <small class="text-warning">
                        <i class="bi bi-slash-circle-fill me-1"></i>
                        Cancelled
                      </small>
                    } @else if (task.status === TaskStatus.QUEUED) {
                      <small class="text-muted">
                        <i class="bi bi-hourglass-split me-1"></i>
                        Queued...
                      </small>
                    } @else if (task.progressPercentage !== undefined && task.progressPercentage !== null) {
                      <div class="progress mt-1" style="height: 4px;">
                        <div
                          class="progress-bar bg-primary"
                          [style.width.%]="getProgressPercentage(task)"
                          role="progressbar">
                        </div>
                      </div>
                      <small class="text-muted">{{ task.progressPercentage }}%</small>
                      @if (task.progressDescription) {
                        <small class="text-muted d-block">{{ task.progressDescription }}</small>
                      }
                    } @else {
                      <small class="text-muted">
                        <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                        Processing...
                      </small>
                    }
                  </div>
                  <div class="d-flex gap-1">
                    @if (task.result?.download_url) {
                      <button
                        class="btn btn-sm btn-outline-primary"
                        (click)="downloadTask(task, $event)"
                        title="Download result">
                        <i class="bi bi-download"></i>
                      </button>
                    }
                    @if (task.status === TaskStatus.QUEUED || task.status === TaskStatus.STARTED) {
                      <button
                        class="btn btn-sm btn-outline-danger"
                        (click)="cancelTask(task.id, $event)"
                        title="Cancel task">
                        <i class="bi bi-x"></i>
                      </button>
                    }
                  </div>
                </div>
              </div>
            </div>
          }
        </div>
      }

      <div class="dropdown-divider"></div>
      <div class="dropdown-item text-center">
        <button class="btn btn-link text-decoration-none" (click)="viewAllTasks()">
          <i class="bi bi-box-arrow-up-right me-1"></i>
          View All Tasks
        </button>
      </div>
    </div>
  }
</div>
