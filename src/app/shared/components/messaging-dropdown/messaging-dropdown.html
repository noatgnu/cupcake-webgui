<div class="messaging-dropdown">
  <button
    #toggleButton
    [class]="getButtonClass()"
    (click)="toggleDropdown()"
    type="button">
    <i class="bi bi-chat-dots fs-5"></i>
    @if (unreadCount() > 0) {
      <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-success">
        {{ unreadCount() > 99 ? '99+' : unreadCount() }}
      </span>
    }
  </button>

  @if (isOpen()) {
    <div
      class="dropdown-menu show"
      [style.bottom.px]="dropdownPosition().bottom"
      [style.left.px]="dropdownPosition().left"
      style="width: 380px; max-height: 500px;">
      <div class="dropdown-header d-flex justify-content-between align-items-center">
        <h6 class="mb-0">Messages</h6>
        <button type="button" class="btn-close btn-sm" (click)="isOpen.set(false)"></button>
      </div>

      @if (loading()) {
        <div class="text-center p-4">
          <div class="spinner-border spinner-border-sm text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>
      } @else if (threads().length === 0) {
        <div class="text-center p-4 text-muted">
          <i class="bi bi-chat-slash fs-1 mb-2 d-block"></i>
          <p class="mb-0">No recent messages</p>
        </div>
      } @else {
        <div class="threads-list" style="max-height: 400px; overflow-y: auto;">
          @for (thread of threads(); track thread.id) {
            <div
              class="dropdown-item thread-item"
              (click)="viewThread(thread)">
              <div class="d-flex gap-2">
                <div class="flex-shrink-0">
                  <i class="bi bi-chat-left-text text-primary"></i>
                </div>
                <div class="flex-grow-1 overflow-hidden">
                  <div class="fw-semibold text-truncate">{{ thread.title }}</div>
                  @if (thread.latestMessage) {
                    <div class="small text-muted text-truncate">
                      <span class="fw-semibold">{{ thread.latestMessage.senderUsername }}:</span>
                      {{ thread.latestMessage.content }}
                    </div>
                  }
                  <div class="d-flex justify-content-between align-items-center mt-1">
                    <span class="small text-muted">{{ getParticipantsText(thread) }}</span>
                    @if (thread.lastMessageAt) {
                      <span class="small text-muted">{{ getTimeAgo(thread.lastMessageAt) }}</span>
                    }
                  </div>
                </div>
                @if (thread.messagesCount && thread.messagesCount > 0) {
                  <div class="flex-shrink-0">
                    <span class="badge bg-success rounded-pill">{{ thread.messagesCount }}</span>
                  </div>
                }
              </div>
            </div>
          }
        </div>
      }

      <div class="dropdown-divider"></div>
      <div class="dropdown-item text-center">
        <button class="btn btn-link text-decoration-none" (click)="viewAll()">
          View All Messages
        </button>
      </div>
    </div>
  }
</div>
