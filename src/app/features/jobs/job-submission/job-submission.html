<div class="container-fluid h-100 d-flex flex-column p-0">
  <nav class="navbar navbar-expand-lg bg-body-tertiary shadow-sm">
    <div class="container-fluid">
      <h4 class="navbar-brand m-0 fw-bold">
        <i class="bi bi-plus-circle me-2"></i>
        @if (state.jobId()) {
          Edit Job Submission
        } @else {
          Submit New Job
        }
      </h4>
    </div>
  </nav>

  <div class="job-content flex-grow-1 p-3" style="min-height: 0;">
    @if (state.loading()) {
      <div class="text-center p-4">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
      </div>
    } @else {
      <div class="job-layout d-flex gap-3 h-100">
        <div class="job-panel-left">
          <div class="card h-100 d-flex flex-column">
            <div class="card-header">
              <h6 class="mb-0">
                <i class="bi bi-list-check me-2"></i>
                Submission Steps
              </h6>
            </div>
            <div class="card-body p-0" style="overflow-y: auto;">
              <div class="list-group list-group-flush">
                <div
                  class="list-group-item list-group-item-action"
                  [class.active]="currentStep() === 1"
                  [class.disabled]="!state.jobId()"
                  (click)="state.jobId() && currentStep.set(1); state.jobId() && updateStepQueryParam(1)"
                  role="button">
                  <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                      <div class="fw-semibold mb-1">
                        <span class="badge bg-primary me-2">1</span>
                        Job & Project
                      </div>
                      <small class="text-muted">Basic information</small>
                    </div>
                    @if (state.jobId()) {
                      <i class="bi bi-check-circle text-success"></i>
                    }
                  </div>
                </div>

                <div
                  class="list-group-item list-group-item-action"
                  [class.active]="currentStep() === 2"
                  [class.disabled]="!state.jobId()"
                  (click)="state.jobId() && currentStep.set(2); state.jobId() && updateStepQueryParam(2)"
                  role="button">
                  <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                      <div class="fw-semibold mb-1">
                        <span class="badge bg-primary me-2">2</span>
                        Lab Group & Staff
                      </div>
                      <small class="text-muted">Select team</small>
                    </div>
                    @if (state.selectedLabGroupId()) {
                      <i class="bi bi-check-circle text-success"></i>
                    }
                  </div>
                </div>

                <div
                  class="list-group-item list-group-item-action"
                  [class.active]="currentStep() === 3"
                  [class.disabled]="!state.jobId()"
                  (click)="state.jobId() && currentStep.set(3); state.jobId() && updateStepQueryParam(3)"
                  role="button">
                  <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                      <div class="fw-semibold mb-1">
                        <span class="badge bg-primary me-2">3</span>
                        Samples
                      </div>
                      <small class="text-muted">Sample count</small>
                    </div>
                    @if (state.sampleNumber() > 0) {
                      <i class="bi bi-check-circle text-success"></i>
                    }
                  </div>
                </div>

                <div
                  class="list-group-item list-group-item-action"
                  [class.active]="currentStep() === 4"
                  [class.disabled]="!state.jobId()"
                  (click)="state.jobId() && currentStep.set(4); state.jobId() && updateStepQueryParam(4)"
                  role="button">
                  <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                      <div class="fw-semibold mb-1">
                        <span class="badge bg-primary me-2">4</span>
                        Template
                      </div>
                      <small class="text-muted">Metadata template</small>
                    </div>
                    @if (state.selectedTemplateId()) {
                      <i class="bi bi-check-circle text-success"></i>
                    }
                  </div>
                </div>

                <div
                  class="list-group-item list-group-item-action"
                  [class.active]="currentStep() === 5"
                  [class.disabled]="!state.jobId()"
                  (click)="state.jobId() && currentStep.set(5); state.jobId() && updateStepQueryParam(5)"
                  role="button">
                  <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                      <div class="fw-semibold mb-1">
                        <span class="badge bg-primary me-2">5</span>
                        Review & Submit
                      </div>
                      <small class="text-muted">Review and submit job</small>
                    </div>
                    @if (state.metadataTableCreated()) {
                      <i class="bi bi-check-circle text-success"></i>
                    }
                  </div>
                </div>

                <div
                  class="list-group-item list-group-item-action"
                  [class.active]="currentStep() === 6"
                  [class.disabled]="!state.jobId() || !state.metadataTableCreated() || !(state.existingJob()?.canEditStaffOnlyColumns || false)"
                  (click)="state.jobId() && state.metadataTableCreated() && (state.existingJob()?.canEditStaffOnlyColumns || false) && currentStep.set(6); state.jobId() && state.metadataTableCreated() && (state.existingJob()?.canEditStaffOnlyColumns || false) && updateStepQueryParam(6)"
                  role="button">
                  <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                      <div class="fw-semibold mb-1">
                        <span class="badge bg-warning text-dark me-2">6</span>
                        Staff Review
                      </div>
                      <small class="text-muted">Staff-only metadata editing</small>
                    </div>
                    @if (state.existingJob()?.canEditStaffOnlyColumns) {
                      <i class="bi bi-shield-lock text-warning"></i>
                    }
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="job-panel-right">
          <div class="card h-100 d-flex flex-column">
            <div class="card-header">
              <h6 class="mb-0">
                Step {{ currentStep() }} of {{ totalSteps }}
              </h6>
            </div>

            <div class="card-body" style="overflow-y: auto;">
              @if (currentStep() === 1) {
                <app-step-one-job-project
                  (createDraft)="createDraftJob()"
                  (saveAndContinue)="saveAndContinue(1)">
                </app-step-one-job-project>
              }

              @if (currentStep() === 2) {
                <app-step-two-lab-group-staff
                  (previous)="previousStep()"
                  (saveAndContinue)="saveAndContinue(2)">
                </app-step-two-lab-group-staff>
              }

              @if (currentStep() === 3) {
                <app-step-three-samples
                  (previous)="previousStep()"
                  (saveAndContinue)="saveAndContinue(3)">
                </app-step-three-samples>
              }

              @if (currentStep() === 4) {
                <app-step-four-template
                  (previous)="previousStep()"
                  (saveAndContinue)="saveAndContinue(4)">
                </app-step-four-template>
              }

              @if (currentStep() === 5) {
                <app-step-five-review-submit
                  (previous)="previousStep()"
                  (createMetadataTable)="createMetadataTable()"
                  (submitJob)="submitJob()">
                </app-step-five-review-submit>
              }

              @if (currentStep() === 6) {
                <app-step-six-staff-review
                  (previous)="previousStep()">
                </app-step-six-staff-review>
              }
            </div>
          </div>
        </div>
      </div>
    }
  </div>
</div>
