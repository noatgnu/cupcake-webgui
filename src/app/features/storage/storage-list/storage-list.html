<div class="container-fluid h-100 d-flex flex-column p-0">
  <!-- Header Section -->
  <nav class="navbar navbar-expand-lg bg-body-tertiary shadow-sm">
    <div class="container-fluid">
      <div class="d-flex align-items-center justify-content-between w-100 flex-wrap gap-3">
        <h4 class="navbar-brand m-0 fw-bold">
          <i class="bi bi-box-seam me-2"></i>Storage Management
        </h4>
        <div class="d-flex gap-2 align-items-center flex-wrap">
          <button class="btn btn-sm btn-outline-primary" (click)="openBarcodeScanModal()" [disabled]="!selectedStorage()">
            <i class="bi bi-upc-scan me-1"></i>
            Scan Barcode
          </button>
          @if (selectedStorage()) {
            <div class="d-flex flex-column gap-1">
              <div class="input-group input-group-sm" style="min-width: 250px;">
                <span class="input-group-text">
                  <i class="bi bi-search"></i>
                </span>
                <input
                  type="search"
                  class="form-control"
                  placeholder="Search reagents..."
                  [(ngModel)]="reagentSearch"
                  (ngModelChange)="onReagentSearchChange()">
              </div>
              <div class="form-check form-check-sm">
                <input
                  class="form-check-input"
                  type="checkbox"
                  id="includeSubStorageSearch"
                  [(ngModel)]="includeSubStorage"
                  (ngModelChange)="onReagentSearchChange()">
                <label class="form-check-label small text-muted" for="includeSubStorageSearch">
                  Include nested storage
                </label>
              </div>
            </div>
          }
          @if (selectedStorage()) {
            <div class="d-flex flex-column gap-1">
              <div class="d-flex gap-1">
                <input
                  type="number"
                  class="form-control form-control-sm"
                  placeholder="Min MW (g/mol)"
                  style="width: 130px;"
                  [(ngModel)]="molecularWeightMin"
                  (ngModelChange)="onReagentFilterChange()"
                  min="0"
                  step="0.01">
                <input
                  type="number"
                  class="form-control form-control-sm"
                  placeholder="Max MW (g/mol)"
                  style="width: 130px;"
                  [(ngModel)]="molecularWeightMax"
                  (ngModelChange)="onReagentFilterChange()"
                  min="0"
                  step="0.01">
              </div>
              <small class="text-muted" style="font-size: 0.75rem;">Filter by molecular weight</small>
            </div>
          }
          <button class="btn btn-sm btn-primary" (click)="openCreateModal(currentStorage())">
            <i class="bi bi-plus-lg me-2"></i>
            Add Storage
          </button>
        </div>
      </div>
    </div>
  </nav>

  <!-- Main Content Area -->
  <div class="storage-content flex-grow-1 p-3" style="min-height: 0;">
    <div class="storage-layout d-flex gap-3 h-100">
  <!-- Left Panel - Child Storage Objects -->
  <div class="storage-panel-left">
    <div class="card">
      <div class="card-header">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h6 class="mb-0">
            <i class="bi bi-boxes me-2"></i>Storage Locations
          </h6>
          <button class="btn btn-sm btn-primary" (click)="openCreateModal(currentStorage())" title="Add child storage">
            <i class="bi bi-plus-lg"></i>
          </button>
        </div>
        @if (breadcrumbs().length > 0) {
          <nav aria-label="breadcrumb">
            <ol class="breadcrumb breadcrumb-sm mb-0">
              <li class="breadcrumb-item">
                <a href="javascript:void(0)" (click)="navigateToRoot()">
                  <i class="bi bi-house-door"></i>
                </a>
              </li>
              @for (crumb of breadcrumbs(); track crumb.id; let isLast = $last) {
                <li class="breadcrumb-item" [class.active]="isLast">
                  @if (!isLast) {
                    <a href="javascript:void(0)" (click)="navigateToBreadcrumb(crumb)">
                      {{ crumb.name }}
                    </a>
                  } @else {
                    <span>{{ crumb.name }}</span>
                  }
                </li>
              }
            </ol>
          </nav>
        }
      </div>
      <div class="card-body">
        @if (loadingChildren()) {
          <div class="text-center p-4">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
          </div>
        } @else if (childStorageObjects().length === 0) {
          <div class="empty-state-small text-center text-muted p-3">
            <i class="bi bi-box-seam fs-2 mb-2 d-block"></i>
            <small>No child storage locations</small>
          </div>
        } @else {
          <div class="list-group list-group-flush">
            @for (storage of childStorageObjects(); track storage.id) {
              <button
                type="button"
                class="list-group-item list-group-item-action text-start d-flex align-items-center"
                [class.active]="selectedStorage()?.id === storage.id"
                (click)="navigateToStorage(storage)">
                @if (storage.pngBase64) {
                  <img
                    [src]="storage.pngBase64"
                    [alt]="storage.objectName"
                    class="storage-thumbnail me-2"
                    (click)="openImageModal($event, storage.pngBase64, storage.objectName)"
                    role="button">
                } @else {
                  <i class="bi {{ getTypeIcon(storage.objectType) }} me-2"></i>
                }
                <div class="flex-grow-1">
                  <div class="fw-semibold">{{ storage.objectName }}</div>
                  @if (storage.objectDescription) {
                    <small class="text-muted d-block">{{ storage.objectDescription }}</small>
                  }
                </div>
                <span class="badge bg-secondary">{{ typeLabels[storage.objectType] }}</span>
              </button>
            }
          </div>
        }
      </div>
      @if (childTotal() > pageSize) {
        <div class="card-footer">
          <nav>
            <ul class="pagination pagination-sm mb-0 justify-content-center">
              <li class="page-item" [class.disabled]="childPage() === 1">
                <button class="page-link" (click)="previousChildPage()">Previous</button>
              </li>
              <li class="page-item disabled">
                <span class="page-link">{{ childPage() }} / {{ Math.ceil(childTotal() / pageSize) }}</span>
              </li>
              <li class="page-item" [class.disabled]="childPage() * pageSize >= childTotal()">
                <button class="page-link" (click)="nextChildPage()">Next</button>
              </li>
            </ul>
          </nav>
        </div>
      }
    </div>
  </div>

  <!-- Right Panel - Stored Reagents -->
  <div class="storage-panel-right">
    <div class="card">
      <div class="card-header">
        <div class="d-flex flex-wrap gap-2 align-items-center">
          <h6 class="mb-0 flex-shrink-0">
            <i class="bi bi-beaker me-2"></i>
            @if (selectedStorage()) {
              <span>{{ selectedStorage()!.objectName }}</span>
            } @else {
              <span class="text-muted">Select a location</span>
            }
          </h6>
          @if (selectedStorage()) {
            @if (isSharedReagentView()) {
              <div class="alert alert-info mb-0 py-1 px-2" style="min-width: 200px;">
                <i class="bi bi-link-45deg me-1"></i>
                <small>Viewing shared reagent</small>
                <button class="btn btn-sm btn-link py-0 px-2" (click)="clearSharedReagentView()">
                  <small>View all</small>
                </button>
              </div>
            }
            <div class="btn-group btn-group-sm ms-auto flex-shrink-0">
              <button class="btn btn-primary" (click)="openAddReagentModal(selectedStorage()!)" title="Add Reagent">
                <i class="bi bi-plus-lg me-1"></i>
                Add Reagent
              </button>
              <button class="btn btn-outline-secondary" (click)="openAccessModal(selectedStorage()!)" title="Manage Access">
                <i class="bi bi-shield-lock"></i>
              </button>
              <button class="btn btn-outline-secondary" (click)="openEditModal(selectedStorage()!)" title="Edit">
                <i class="bi bi-pencil"></i>
              </button>
              <button class="btn btn-outline-danger" (click)="deleteStorage(selectedStorage()!.id)" title="Delete">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          }
        </div>
      </div>
      <div class="card-body">
        @if (!selectedStorage()) {
          <div class="empty-state text-center text-muted p-5">
            <i class="bi bi-box-seam fs-1 mb-3 d-block"></i>
            <h5>No Storage Location Selected</h5>
            <p>Select a storage location from the left panel to view its contents</p>
          </div>
        } @else if (loadingReagents()) {
          <div class="text-center p-4">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
          </div>
        } @else if (storedReagents().length === 0) {
          <div class="empty-state text-center text-muted p-4">
            <i class="bi bi-flask fs-1 mb-3 d-block"></i>
            <h6>No Reagents</h6>
            <p class="mb-0">This storage location doesn't contain any reagents yet</p>
          </div>
        } @else {
          <div class="list-group list-group-flush">
            @for (reagent of storedReagents(); track reagent.id) {
              <div class="list-group-item">
                <div class="d-flex justify-content-between align-items-start gap-2">
                  @if (reagent.pngBase64) {
                    <img
                      [src]="reagent.pngBase64"
                      [alt]="reagent.reagentName || 'Reagent'"
                      class="reagent-thumbnail"
                      (click)="openImageModal($event, reagent.pngBase64, reagent.reagentName || 'Reagent')"
                      role="button">
                  } @else {
                    <div class="reagent-placeholder">
                      <i class="bi bi-flask"></i>
                    </div>
                  }
                  <div class="flex-grow-1">
                    <h6 class="mb-1">{{ reagent.reagentName || 'Reagent #' + reagent.reagent }}</h6>
                    @if (shouldShowStoragePath(reagent)) {
                      @if (getReagentStoragePath(reagent); as path) {
                        <div class="storage-path-breadcrumb mb-1">
                          <small class="text-muted">
                            <i class="bi bi-box-seam me-1"></i>
                            @for (item of path; track item.id; let isLast = $last) {
                              <span>{{ item.name }}</span>
                              @if (!isLast) {
                                <i class="bi bi-chevron-right mx-1"></i>
                              }
                            }
                          </small>
                        </div>
                      }
                    }
                    <small class="text-muted">
                      Quantity: {{ reagent.quantity }}{{ reagent.reagentUnit ? ' ' + reagent.reagentUnit : '' }}
                      @if (reagent.currentQuantity !== reagent.quantity) {
                        <span class="text-warning">(Current: {{ reagent.currentQuantity }}{{ reagent.reagentUnit ? ' ' + reagent.reagentUnit : '' }})</span>
                      }
                    </small>
                    @if (reagent.molecularWeight) {
                      <div class="text-muted small mt-1">
                        <i class="bi bi-calculator me-1"></i>
                        MW: {{ reagent.molecularWeight }} g/mol
                      </div>
                    }
                    @if (reagent.barcode) {
                      <div class="text-muted small mt-1">
                        <i class="bi bi-upc-scan me-1"></i>
                        <span class="font-monospace">{{ reagent.barcode }}</span>
                      </div>
                    }
                    @if (reagent.notes) {
                      <div class="text-muted small mt-1">{{ reagent.notes }}</div>
                    }
                    @if (reagent.metadataTableId && getReagentMetadata(reagent).length > 0) {
                      <div class="mt-2 d-flex flex-wrap gap-1">
                        @for (column of getReagentMetadata(reagent); track column.id) {
                          <span class="badge bg-primary" [ngbTooltip]="column.name" placement="top">
                            {{ column.value || 'N/A' }}
                          </span>
                        }
                      </div>
                    }
                  </div>
                  <div class="btn-group btn-group-sm">
                    @if (reagent.metadataTableId) {
                      <button class="btn btn-outline-primary" title="Manage Metadata" (click)="openReagentMetadataModal(reagent)">
                        <i class="bi bi-tags"></i>
                      </button>
                    }
                    <button class="btn btn-outline-primary" title="Add Quantity" (click)="openAddQuantityModal(reagent)">
                      <i class="bi bi-plus-circle"></i>
                    </button>
                    <button class="btn btn-outline-danger" title="Reserve Quantity" (click)="openReserveQuantityModal(reagent)">
                      <i class="bi bi-dash-circle"></i>
                    </button>
                    <button class="btn btn-outline-secondary" title="Usage Journal" (click)="openUsageJournalModal(reagent)">
                      <i class="bi bi-journal-text"></i>
                    </button>
                    <button class="btn btn-outline-secondary" title="Documents" (click)="openAnnotationsModal(reagent)">
                      <i class="bi bi-folder2-open"></i>
                    </button>
                    <button class="btn btn-outline-secondary" title="Manage Access" (click)="openReagentAccessModal(reagent)">
                      <i class="bi bi-shield-lock"></i>
                    </button>
                    <button class="btn btn-outline-info" title="Copy Share Link" (click)="copyReagentShareLink(reagent)">
                      <i class="bi bi-share"></i>
                    </button>
                    <button class="btn btn-outline-secondary" title="Edit" (click)="openEditReagentModal(reagent)">
                      <i class="bi bi-pencil"></i>
                    </button>
                  </div>
                </div>
              </div>
            }
          </div>
        }
      </div>
      @if (reagentTotal() > pageSize) {
        <div class="card-footer">
          <nav>
            <ul class="pagination pagination-sm mb-0 justify-content-center">
              <li class="page-item" [class.disabled]="reagentPage() === 1">
                <button class="page-link" (click)="previousReagentPage()">Previous</button>
              </li>
              <li class="page-item disabled">
                <span class="page-link">{{ reagentPage() }} / {{ Math.ceil(reagentTotal() / pageSize) }}</span>
              </li>
              <li class="page-item" [class.disabled]="reagentPage() * pageSize >= reagentTotal()">
                <button class="page-link" (click)="nextReagentPage()">Next</button>
              </li>
            </ul>
          </nav>
        </div>
      }
    </div>
  </div>
    </div>
  </div>
</div>
