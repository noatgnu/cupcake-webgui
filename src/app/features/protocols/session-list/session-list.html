<div class="container-fluid h-100 d-flex flex-column p-0">
  <!-- Header Section -->
  <nav class="navbar navbar-expand-lg bg-body-tertiary shadow-sm">
    <div class="container-fluid">
      <div class="d-flex align-items-center justify-content-between w-100">
        <h4 class="navbar-brand m-0 fw-bold">
          <i class="bi bi-play-circle me-2"></i>Sessions
        </h4>
        <div class="input-group" style="width: 300px;">
          <span class="input-group-text">
            <i class="bi bi-search"></i>
          </span>
          <input
            type="search"
            class="form-control"
            placeholder="Search sessions..."
            [(ngModel)]="searchTerm"
            (ngModelChange)="onSearchChange()">
        </div>
      </div>
    </div>
  </nav>

  <div class="session-content flex-grow-1 p-3" style="min-height: 0;">
    @if (loading()) {
      <div class="text-center p-4">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
      </div>
    } @else {
      <div class="session-layout d-flex gap-3 h-100">
        <div class="session-panel-left d-flex flex-column gap-3">
          <div class="card flex-grow-1 d-flex flex-column" style="min-height: 0;">
            <div class="card-header flex-shrink-0">
              <div class="d-flex justify-content-between align-items-center">
                <h6 class="mb-0">
                  <i class="bi bi-list-check me-2"></i>
                  My Sessions
                </h6>
                <span class="badge bg-secondary">{{ total() }}</span>
              </div>
            </div>
            <div class="card-body flex-grow-1 p-0" style="overflow-y: auto; min-height: 0;">
              @if (sessions().length === 0) {
                <div class="empty-state text-center text-muted p-5">
                  <i class="bi bi-play-circle fs-1 mb-3 d-block"></i>
                  @if (searchTerm) {
                    <h5>No Sessions Found</h5>
                    <p class="mb-3">No sessions match your search criteria</p>
                    <button class="btn btn-outline-primary" (click)="searchTerm = ''; onSearchChange()">
                      Clear Search
                    </button>
                  } @else {
                    <h5>No Sessions</h5>
                    <p class="mb-3">No experimental sessions have been created yet</p>
                  }
                </div>
              } @else {
                <div class="list-group list-group-flush">
                  @for (session of sessions(); track session.id; let i = $index) {
                    <button
                      type="button"
                      class="list-group-item list-group-item-action text-start"
                      [class.active]="selectedSessionIndex() === i"
                      (click)="selectSession(i)"
                      (dblclick)="openSessionDetail(session.id)">
                      <div class="d-flex justify-content-between align-items-center">
                        <div class="flex-grow-1">
                          <div class="d-flex align-items-center mb-1">
                            <h6 class="mb-0">{{ session.name || 'Untitled Session' }}</h6>
                            <span class="badge ms-2" [class]="getSessionStatusClass(session)">
                              {{ getSessionStatus(session) }}
                            </span>
                          </div>
                          @if (session.protocolCount !== undefined) {
                            <small class="text-muted">
                              <i class="bi bi-journal-medical me-1"></i>
                              {{ session.protocolCount }} protocol{{ session.protocolCount !== 1 ? 's' : '' }}
                            </small>
                          }
                        </div>
                        <button
                          class="btn btn-sm btn-outline-primary ms-2"
                          (click)="openSessionDetail(session.id); $event.stopPropagation()"
                          title="Open Session">
                          <i class="bi bi-box-arrow-up-right"></i>
                        </button>
                      </div>
                    </button>
                  }
                </div>
              }
            </div>
            @if (total() > pageSize) {
              <div class="card-footer flex-shrink-0">
                <nav>
                  <ul class="pagination pagination-sm mb-0 justify-content-center">
                    <li class="page-item" [class.disabled]="page() === 1">
                      <button class="page-link" (click)="previousPage()">Previous</button>
                    </li>
                    <li class="page-item disabled">
                      <span class="page-link">{{ page() }} / {{ Math.ceil(total() / pageSize) }}</span>
                    </li>
                    <li class="page-item" [class.disabled]="page() * pageSize >= total()">
                      <button class="page-link" (click)="nextPage()">Next</button>
                    </li>
                  </ul>
                </nav>
              </div>
            }
          </div>
        </div>

        <div class="session-panel-right">
          <div class="card h-100 d-flex flex-column">
            <div class="card-header flex-shrink-0">
              <div class="d-flex justify-content-between align-items-center">
                <h6 class="mb-0">
                  @if (selectedSession()) {
                    <i class="bi bi-info-circle me-2"></i>
                    Session Details
                  } @else {
                    <span class="text-muted">No Session Selected</span>
                  }
                </h6>
                @if (selectedSession()) {
                  <div class="btn-group btn-group-sm">
                    <button
                      class="btn btn-outline-success"
                      (click)="openSessionDetail(selectedSession()!.id)"
                      title="Open Session">
                      <i class="bi bi-box-arrow-up-right"></i>
                    </button>
                    <button
                      class="btn btn-outline-primary"
                      (click)="editSession(selectedSession()!)"
                      title="Edit Session">
                      <i class="bi bi-pencil"></i>
                    </button>
                    <button
                      class="btn btn-outline-danger"
                      (click)="deleteSession(selectedSession()!.id, $event)"
                      title="Delete Session">
                      <i class="bi bi-trash"></i>
                    </button>
                  </div>
                }
              </div>
            </div>

            <div class="card-body flex-grow-1" style="overflow-y: auto; min-height: 0;">
              @if (!selectedSession()) {
                <div class="empty-state text-center text-muted p-5">
                  <i class="bi bi-arrow-left fs-1 mb-3 d-block"></i>
                  <h5>No Session Selected</h5>
                  <p>Select a session from the left panel to view details</p>
                </div>
              } @else {
                <div class="session-details">
                  <div class="mb-4">
                    <h5>{{ selectedSession()!.name || 'Untitled Session' }}</h5>
                  </div>

                  <div class="mb-4">
                    <h6 class="text-muted mb-2">Status</h6>
                    <span class="badge" [class]="getSessionStatusClass(selectedSession()!)">
                      {{ getSessionStatus(selectedSession()!) }}
                    </span>
                  </div>

                  <div class="mb-4">
                    <h6 class="text-muted mb-2">Visibility</h6>
                    <div class="form-check form-switch">
                      <input
                        class="form-check-input"
                        type="checkbox"
                        id="sessionPublicToggle"
                        [checked]="selectedSession()!.enabled"
                        (click)="toggleEnabled(selectedSession()!, $event)"
                        title="Make session viewable to everyone">
                      <label class="form-check-label" for="sessionPublicToggle">
                        Public (viewable to everyone)
                      </label>
                    </div>
                  </div>

                  <div class="mb-4">
                    <h6 class="text-muted mb-2">Timeline</h6>
                    <div class="small">
                      @if (selectedSession()!.startedAt) {
                        <div class="mb-1">
                          <i class="bi bi-play-fill text-primary me-2"></i>
                          Started: {{ selectedSession()!.startedAt | date: 'medium' }}
                        </div>
                      }
                      @if (selectedSession()!.endedAt) {
                        <div class="mb-1">
                          <i class="bi bi-stop-fill text-success me-2"></i>
                          Ended: {{ selectedSession()!.endedAt | date: 'medium' }}
                        </div>
                      }
                      @if (selectedSession()!.duration !== undefined && selectedSession()!.duration! > 0) {
                        <div class="mb-1">
                          <i class="bi bi-clock me-2"></i>
                          Duration: {{ selectedSession()!.duration }} minutes
                        </div>
                      }
                      @if (!selectedSession()!.startedAt) {
                        <div class="text-muted">
                          <i class="bi bi-dash-circle me-2"></i>
                          Not yet started
                        </div>
                      }
                    </div>
                  </div>

                  @if (selectedSession()!.editorsUsernames && selectedSession()!.editorsUsernames!.length > 0) {
                    <div class="mb-4">
                      <h6 class="text-muted mb-2">Editors</h6>
                      <div class="d-flex flex-wrap gap-1">
                        @for (editor of selectedSession()!.editorsUsernames!; track editor) {
                          <span class="badge bg-primary">
                            <i class="bi bi-pencil me-1"></i>{{ editor }}
                          </span>
                        }
                      </div>
                    </div>
                  }

                  @if (selectedSession()!.viewersUsernames && selectedSession()!.viewersUsernames!.length > 0) {
                    <div class="mb-4">
                      <h6 class="text-muted mb-2">Viewers</h6>
                      <div class="d-flex flex-wrap gap-1">
                        @for (viewer of selectedSession()!.viewersUsernames!; track viewer) {
                          <span class="badge bg-secondary">
                            <i class="bi bi-eye me-1"></i>{{ viewer }}
                          </span>
                        }
                      </div>
                    </div>
                  }

                  <div class="mb-3">
                    <h6 class="text-muted mb-2">
                      <i class="bi bi-journal-medical me-2"></i>
                      Protocols ({{ selectedSessionProtocols().length }})
                    </h6>
                    @if (loadingProtocols()) {
                      <div class="text-center p-3">
                        <div class="spinner-border spinner-border-sm text-primary" role="status">
                          <span class="visually-hidden">Loading...</span>
                        </div>
                      </div>
                    } @else if (selectedSessionProtocols().length === 0) {
                      <div class="text-muted small">No protocols associated with this session</div>
                    } @else {
                      <div class="list-group">
                        @for (protocol of selectedSessionProtocols(); track protocol.id) {
                          <button
                            type="button"
                            class="list-group-item list-group-item-action text-start"
                            (click)="openProtocolEditor(protocol.id)">
                            <div class="d-flex justify-content-between align-items-start">
                              <div class="flex-grow-1">
                                <h6 class="mb-1">{{ protocol.protocolTitle || 'Untitled Protocol' }}</h6>
                                @if (protocol.protocolDescription) {
                                  <p class="mb-1 small text-muted">{{ protocol.protocolDescription }}</p>
                                }
                                <div class="d-flex gap-2 small text-muted">
                                  @if (protocol.stepsCount !== undefined && protocol.stepsCount !== null) {
                                    <span><i class="bi bi-list-check me-1"></i>{{ protocol.stepsCount }} steps</span>
                                  }
                                  @if (protocol.averageDuration !== undefined && protocol.averageDuration !== null) {
                                    <span><i class="bi bi-clock me-1"></i>{{ protocol.averageDuration.toFixed(1) }}/5</span>
                                  }
                                </div>
                              </div>
                              <i class="bi bi-chevron-right"></i>
                            </div>
                          </button>
                        }
                      </div>
                    }
                  </div>

                  <div class="small text-muted mt-4">
                    <div>Created: {{ selectedSession()!.createdAt | date: 'medium' }}</div>
                    <div>Updated: {{ selectedSession()!.updatedAt | date: 'medium' }}</div>
                  </div>
                </div>
              }
            </div>
          </div>
        </div>
      </div>
    }
  </div>
</div>
