<div class="modal-header">
  <h5 class="modal-title">
    <i class="bi bi-flask me-2"></i>
    Book Reagent: {{ stepReagent.reagentName }}
  </h5>
  <button type="button" class="btn-close" (click)="cancel()"></button>
</div>

<div class="modal-body">
  <div class="mb-4">
    <div class="alert alert-info">
      <strong>Required:</strong> {{ stepReagent.scaledQuantity || stepReagent.quantity }}
      @if (stepReagent.reagentUnit) {
        {{ stepReagent.reagentUnit }}
      }
      @if (stepReagent.scalable && stepReagent.scaledQuantity !== undefined) {
        <span class="ms-2">(Original: {{ stepReagent.quantity }} {{ stepReagent.reagentUnit }})</span>
      }
    </div>
  </div>

  <div class="mb-3">
    <label for="search" class="form-label">Search Available Stored Reagents</label>
    <input
      type="text"
      class="form-control"
      id="search"
      [value]="searchTerm()"
      (input)="onSearchChange($any($event.target).value)"
      placeholder="Search by storage location, barcode, or notes...">
  </div>

  @if (loading()) {
    <div class="text-center py-4">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>
  } @else if (storedReagents().length === 0) {
    <div class="alert alert-warning">
      <i class="bi bi-exclamation-triangle me-2"></i>
      No available stored reagents found. Please add reagent to storage first.
    </div>
  } @else {
    <div class="mb-3">
      <label class="form-label">Select Stored Reagent</label>
      <div class="list-group" style="max-height: 300px; overflow-y: auto;">
        @for (reagent of storedReagents(); track reagent.id) {
          <button
            type="button"
            class="list-group-item list-group-item-action"
            [class.active]="isSelected(reagent)"
            (click)="selectReagent(reagent)">
            <div class="d-flex justify-content-between align-items-start">
              <div class="flex-grow-1">
                <div class="fw-semibold">
                  @if (reagent.storageObjectName) {
                    <i class="bi bi-box-seam me-1"></i>
                    {{ reagent.storageObjectName }}
                  } @else {
                    No storage location
                  }
                </div>
                <div class="small">
                  Available: <strong>{{ reagent.currentQuantity }} {{ reagent.reagentUnit }}</strong>
                  @if (reagent.barcode) {
                    <span class="ms-2"><i class="bi bi-upc-scan me-1"></i>{{ reagent.barcode }}</span>
                  }
                </div>
                @if (reagent.notes) {
                  <div class="small text-muted mt-1">{{ reagent.notes }}</div>
                }
                @if (reagent.expirationDate) {
                  <div class="small">
                    <i class="bi bi-calendar-event me-1"></i>
                    Expires: {{ reagent.expirationDate | date: 'mediumDate' }}
                  </div>
                }
              </div>
              @if (reagent.currentQuantity < (stepReagent.scaledQuantity || stepReagent.quantity)) {
                <span class="badge bg-warning text-dark">Insufficient</span>
              } @else {
                <span class="badge bg-success">Available</span>
              }
            </div>
          </button>
        }
      </div>
    </div>
  }

  @if (selectedReagent()) {
    <div class="card bg-light mb-3">
      <div class="card-body">
        <h6 class="card-title">Booking Details</h6>
        <div class="mb-3">
          <label for="quantity" class="form-label">
            Quantity to Book <span class="text-danger">*</span>
          </label>
          <div class="input-group">
            <input
              type="number"
              class="form-control"
              id="quantity"
              [value]="quantity()"
              (input)="updateQuantity($any($event.target).value)"
              [max]="availableQuantity()"
              min="0"
              step="0.01">
            <span class="input-group-text">{{ stepReagent.reagentUnit || 'units' }}</span>
          </div>
          @if (!isValidQuantity() && quantity() > 0) {
            <div class="form-text text-danger">
              Quantity must be between 0 and {{ availableQuantity() }}
            </div>
          }
          <div class="form-text">
            Available: {{ availableQuantity() }} {{ stepReagent.reagentUnit }}
          </div>
        </div>

        <div class="mb-3">
          <label for="notes" class="form-label">Notes (Optional)</label>
          <textarea
            class="form-control"
            id="notes"
            rows="2"
            [value]="notes()"
            (input)="updateNotes($any($event.target).value)"
            placeholder="Add any notes about this booking..."></textarea>
        </div>
      </div>
    </div>
  }
</div>

<div class="modal-footer">
  <button type="button" class="btn btn-secondary" (click)="cancel()" [disabled]="saving()">
    Cancel
  </button>
  <button
    type="button"
    class="btn btn-primary"
    (click)="bookReagent()"
    [disabled]="!selectedReagent() || !isValidQuantity() || saving()">
    @if (saving()) {
      <span class="spinner-border spinner-border-sm me-2"></span>
    }
    Book Reagent
  </button>
</div>
