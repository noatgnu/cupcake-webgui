<div class="card">
  <div class="card-header">
    <h6 class="mb-0">
      <i class="bi bi-calendar-check me-2"></i>
      Book Instrument
    </h6>
  </div>
  <div class="card-body">
    @if (loadingInstruments()) {
      <div class="text-center py-3">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading instruments...</span>
        </div>
        <p class="text-muted mt-2">Loading available instruments...</p>
      </div>
    } @else {
      <div class="mb-3">
        <label for="instrumentSearch" class="form-label">
          <i class="bi bi-search me-1"></i>Search Instruments
        </label>
        <input
          type="text"
          class="form-control"
          id="instrumentSearch"
          placeholder="Search by name or description..."
          [value]="searchQuery()"
          (input)="onSearchChange($any($event.target).value)"
          [disabled]="creating()">
      </div>

      @if (availableInstruments().length === 0 && !loadingInstruments()) {
        <div class="alert alert-warning">
          <i class="bi bi-exclamation-triangle me-2"></i>
          @if (searchQuery()) {
            No instruments found matching your search.
          } @else {
            You don't have permission to book any instruments, or no bookable instruments are available.
          }
        </div>
      } @else {
        <div class="mb-3">
          <label for="instrumentSelect" class="form-label">
            <i class="bi bi-gear me-1"></i>Select Instrument
          </label>
          <select
            class="form-select"
            id="instrumentSelect"
            [value]="selectedInstrumentId() || ''"
            (change)="onInstrumentSelected($any($event.target).value)"
            [disabled]="creating()">
            <option value="">-- Select an instrument --</option>
            @for (instrument of availableInstruments(); track instrument.id) {
              <option [value]="instrument.id">{{ instrument.instrumentName }}</option>
            }
          </select>
          @if (selectedInstrument()) {
            <div class="mt-2">
              <div class="small text-muted mb-1">
                <i class="bi bi-info-circle me-1"></i>
                {{ selectedInstrument()!.instrumentDescription || 'No description available' }}
              </div>
              @if (selectedInstrument()!.allowOverlappingBookings) {
                <div class="small text-success">
                  <i class="bi bi-check-circle me-1"></i>
                  Overlapping bookings allowed
                </div>
              } @else {
                <div class="small text-warning">
                  <i class="bi bi-exclamation-circle me-1"></i>
                  Overlapping bookings not allowed
                </div>
              }
            </div>
          }
        </div>

        @if (totalPages() > 1) {
          <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="small text-muted">
              Page {{ currentPage() }} of {{ totalPages() }} ({{ totalInstruments() }} total)
            </div>
            <div class="btn-group btn-group-sm">
              <button
                class="btn btn-outline-secondary"
                (click)="previousPage()"
                [disabled]="currentPage() === 1 || creating()">
                <i class="bi bi-chevron-left"></i>
              </button>
              <button
                class="btn btn-outline-secondary"
                (click)="nextPage()"
                [disabled]="currentPage() === totalPages() || creating()">
                <i class="bi bi-chevron-right"></i>
              </button>
            </div>
          </div>
        }

        <div class="row g-3 mb-3">
          <div class="col-md-6">
            <label for="startDateTime" class="form-label">
              <i class="bi bi-clock me-1"></i>Start Time
            </label>
            <input
              type="datetime-local"
              class="form-control"
              id="startDateTime"
              [value]="startDateTime()"
              (input)="startDateTime.set($any($event.target).value); onDateTimeChange()"
              [disabled]="creating()">
          </div>
          <div class="col-md-6">
            <label for="endDateTime" class="form-label">
              <i class="bi bi-clock-fill me-1"></i>End Time
            </label>
            <input
              type="datetime-local"
              class="form-control"
              id="endDateTime"
              [value]="endDateTime()"
              (input)="endDateTime.set($any($event.target).value); onDateTimeChange()"
              [disabled]="creating()">
          </div>
        </div>

        @if (calculateDuration()) {
          <div class="alert alert-info mb-3">
            <i class="bi bi-hourglass-split me-2"></i>
            <strong>Duration:</strong> {{ calculateDuration() }}
          </div>
        }

        @if (loadingBookings()) {
          <div class="alert alert-secondary mb-3">
            <div class="d-flex align-items-center">
              <div class="spinner-border spinner-border-sm me-2" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <span>Checking for existing bookings...</span>
            </div>
          </div>
        }

        @if (!loadingBookings() && selectedInstrumentId() && startDateTime() && endDateTime()) {
          @if (existingBookings().length > 0) {
            <div class="mb-3">
              <div class="card">
                <div class="card-header">
                  <div class="d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">
                      <i class="bi bi-calendar-event me-1"></i>
                      Booking Timeline
                    </h6>
                    <span class="badge bg-secondary">{{ existingBookings().length }} booking(s)</span>
                  </div>
                </div>
                <div class="card-body">
                  @if (hasOverlappingBookings() && !selectedInstrument()?.allowOverlappingBookings) {
                    <div class="alert alert-warning mb-3">
                      <i class="bi bi-exclamation-triangle me-1"></i>
                      <strong>Warning:</strong> Your booking overlaps with existing bookings and this instrument does not allow overlapping bookings!
                    </div>
                  }
                  @if (hasOverlappingBookings() && selectedInstrument()?.allowOverlappingBookings) {
                    <div class="alert alert-info mb-3">
                      <i class="bi bi-info-circle me-1"></i>
                      <strong>Note:</strong> Your booking overlaps with existing bookings, but this instrument allows overlapping bookings.
                    </div>
                  }

                  <div class="mb-3">
                    <div class="d-flex align-items-center mb-2">
                      <div class="me-3">
                        <span class="badge" style="background-color: #0d6efd33; color: #0d6efd; border: 2px solid #0d6efd;">Your Booking</span>
                      </div>
                      <div class="me-3">
                        <span class="badge bg-success">Approved Booking</span>
                      </div>
                      <div>
                        <span class="badge bg-warning text-dark">Pending Booking</span>
                      </div>
                    </div>
                  </div>

                  <div class="position-relative" style="min-height: 100px;">
                    <div class="border rounded p-2" style="background: linear-gradient(to right, #f8f9fa 0%, #e9ecef 100%);">
                      <div class="small text-muted mb-1">
                        <strong>{{ getTimelineStartDate() | date:'EEE, MMM d, y' }}</strong>
                      </div>
                      <div class="position-relative" [style.height.px]="getTimelineHeight()">
                        <div
                          class="position-absolute rounded px-2 py-1 small"
                          [style.left.%]="calculateYourBookingPosition().left"
                          [style.width.%]="calculateYourBookingPosition().width"
                          style="top: 0; background-color: #0d6efd33; color: #0d6efd; border: 2px solid #0d6efd; z-index: 3; font-weight: 600; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                          <i class="bi bi-calendar-plus me-1"></i>Your Booking
                        </div>
                        @for (booking of existingBookings(); track booking.id) {
                          <div
                            class="position-absolute rounded px-2 py-1 small"
                            [style.left.%]="calculateBookingPosition(booking).left"
                            [style.width.%]="calculateBookingPosition(booking).width"
                            [style.top.px]="calculateBookingRow(booking) * 24"
                            [style.background-color]="booking.approved ? '#198754' : '#ffc107'"
                            [style.color]="booking.approved ? 'white' : '#000'"
                            [title]="getBookingTooltip(booking)"
                            style="z-index: 2; border: 1px solid rgba(0,0,0,0.1); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                            <i class="bi bi-person-fill me-1"></i>{{ booking.userUsername || 'Unknown' }}
                          </div>
                        }
                      </div>
                      <div class="d-flex justify-content-between small text-muted mt-2">
                        <span>{{ getTimelineStartDate() | date:'h:mm a' }}</span>
                        <span>{{ getTimelineEndDate() | date:'h:mm a' }}</span>
                      </div>
                    </div>
                  </div>

                  <div class="mt-3">
                    <div class="small text-muted mb-2"><strong>Booking Details:</strong></div>
                    @for (booking of existingBookings(); track booking.id) {
                      <div class="small border-top pt-2 mt-2">
                        <div class="d-flex justify-content-between">
                          <span class="fw-semibold">{{ booking.userUsername || 'Unknown User' }}</span>
                          @if (booking.approved) {
                            <span class="badge bg-success">Approved</span>
                          } @else {
                            <span class="badge bg-warning text-dark">Pending</span>
                          }
                        </div>
                        <div class="text-muted">
                          <i class="bi bi-clock me-1"></i>
                          {{ booking.timeStarted | date:'short' }} - {{ booking.timeEnded | date:'short' }}
                        </div>
                        @if (booking.description) {
                          <div class="text-muted fst-italic">{{ booking.description }}</div>
                        }
                      </div>
                    }
                  </div>
                </div>
              </div>
            </div>
          } @else {
            <div class="alert alert-success mb-3">
              <i class="bi bi-check-circle me-1"></i>
              No existing bookings in this time range. This time slot is available!
            </div>
          }
        }

        <div class="mb-3">
          <label for="bookingDescription" class="form-label">
            Description (Optional)
          </label>
          <textarea
            class="form-control"
            id="bookingDescription"
            rows="3"
            [value]="bookingDescription()"
            (input)="bookingDescription.set($any($event.target).value)"
            placeholder="Add notes about this booking"
            [disabled]="creating()"></textarea>
        </div>

      }
    }
  </div>
</div>
