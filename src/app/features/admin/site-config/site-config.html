<div class="container-fluid h-100 d-flex flex-column p-0">
  <app-admin-navbar></app-admin-navbar>

  <div class="flex-grow-1 p-4 overflow-auto">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h4 class="m-0 fw-bold">
        <i class="bi bi-gear-fill me-2"></i>Site Configuration
      </h4>
      @if (canEdit()) {
        <div class="d-flex gap-2">
          <button type="button" class="btn btn-outline-secondary btn-sm" (click)="resetForm()" [disabled]="saving() || loading()">
            <i class="bi bi-arrow-counterclockwise me-1"></i>Reset
          </button>
          <button type="button" class="btn btn-primary btn-sm" (click)="saveConfig()" [disabled]="saving() || loading()">
            @if (saving()) {
              <span class="spinner-border spinner-border-sm me-2"></span>
            }
            <i class="bi bi-save me-1"></i>Save Changes
          </button>
        </div>
      }
    </div>

      @if (loading()) {
        <div class="text-center py-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>
      } @else if (config()) {
        <div class="row g-4">
          <div class="col-lg-8">
            <div class="card mb-4">
              <div class="card-header">
                <h5 class="mb-0">General Settings</h5>
              </div>
              <div class="card-body">
                <div class="mb-3">
                  <label for="siteName" class="form-label">Site Name</label>
                  <input type="text" class="form-control" id="siteName" [value]="formData().siteName" (input)="updateField('siteName', $any($event.target).value)" [disabled]="!canEdit()">
                  <div class="form-text">The name displayed in the browser title and header.</div>
                </div>

                <div class="mb-3">
                  <label for="logoUrl" class="form-label">Logo URL</label>
                  <input type="text" class="form-control" id="logoUrl" [value]="formData().logoUrl" (input)="updateField('logoUrl', $any($event.target).value)" [disabled]="!canEdit()">
                  <div class="form-text">URL to the logo image file.</div>
                </div>

                <div class="mb-3">
                  <label for="primaryColor" class="form-label">Primary Color</label>
                  <div class="input-group">
                    <input type="color" class="form-control form-control-color" id="primaryColor" [value]="formData().primaryColor" (input)="updateField('primaryColor', $any($event.target).value)" [disabled]="!canEdit()">
                    <input type="text" class="form-control" [value]="formData().primaryColor" (input)="updateField('primaryColor', $any($event.target).value)" [disabled]="!canEdit()">
                  </div>
                  <div class="form-text">The primary theme color used throughout the application.</div>
                </div>

                <div class="mb-3">
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="showPoweredBy" [checked]="formData().showPoweredBy" (change)="updateField('showPoweredBy', $any($event.target).checked)" [disabled]="!canEdit()">
                    <label class="form-check-label" for="showPoweredBy">
                      Show "Powered By" Footer
                    </label>
                  </div>
                  <div class="form-text">Display attribution footer at the bottom of pages.</div>
                </div>
              </div>
            </div>

            <div class="card mb-4">
              <div class="card-header">
                <h5 class="mb-0">Authentication Settings</h5>
              </div>
              <div class="card-body">
                <div class="mb-3">
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="allowUserRegistration" [checked]="formData().allowUserRegistration" (change)="updateField('allowUserRegistration', $any($event.target).checked)" [disabled]="!canEdit()">
                    <label class="form-check-label" for="allowUserRegistration">
                      Allow User Registration
                    </label>
                  </div>
                  <div class="form-text">Enable self-service user registration.</div>
                </div>

                <div class="mb-3">
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="enableOrcidLogin" [checked]="formData().enableOrcidLogin" (change)="updateField('enableOrcidLogin', $any($event.target).checked)" [disabled]="!canEdit()">
                    <label class="form-check-label" for="enableOrcidLogin">
                      Enable ORCID Login
                    </label>
                  </div>
                  <div class="form-text">Allow users to login using ORCID authentication.</div>
                </div>
              </div>
            </div>

            <div class="card mb-4">
              <div class="card-header">
                <h5 class="mb-0">Reagent Booking Settings</h5>
              </div>
              <div class="card-body">
                <div class="mb-3">
                  <label for="bookingDeletionWindow" class="form-label">Booking Deletion Window (minutes)</label>
                  <input type="number" class="form-control" id="bookingDeletionWindow" [value]="formData().bookingDeletionWindowMinutes" (input)="updateField('bookingDeletionWindowMinutes', parseInt($any($event.target).value))" [disabled]="!canEdit()" min="0">
                  <div class="form-text">Time window before a booking starts during which it cannot be deleted.</div>
                </div>
              </div>
            </div>

            <div class="card mb-4">
              <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                  <h5 class="mb-0">Whisper C++ Transcription Settings</h5>
                  <button type="button" class="btn btn-sm btn-outline-primary" (click)="refreshWhisperModels()" [disabled]="refreshingWhisperModels() || !canEdit()">
                    @if (refreshingWhisperModels()) {
                      <span class="spinner-border spinner-border-sm me-1"></span>
                    } @else {
                      <i class="bi bi-arrow-clockwise me-1"></i>
                    }
                    Refresh Models
                  </button>
                </div>
              </div>
              <div class="card-body">
                <div class="mb-3">
                  <label for="whisperCppModel" class="form-label">Default Whisper Model</label>
                  @if (loadingWhisperModels()) {
                    <div class="text-center py-2">
                      <div class="spinner-border spinner-border-sm text-primary" role="status">
                        <span class="visually-hidden">Loading models...</span>
                      </div>
                    </div>
                  } @else {
                    <select class="form-select" id="whisperCppModel" [value]="formData().whisperCppModel" (change)="updateField('whisperCppModel', $any($event.target).value)" [disabled]="!canEdit()">
                      <option value="">Select a model</option>
                      @for (model of availableWhisperModels(); track model.path) {
                        <option [value]="model.path">{{ model.name }} ({{ model.size }})</option>
                      }
                    </select>
                  }
                  <div class="form-text">The default Whisper C++ model to use for audio transcription. Click "Refresh Models" to scan for available models.</div>
                </div>
              </div>
            </div>

            <div class="card mb-4">
              <div class="card-header">
                <h5 class="mb-0">UI Feature Visibility</h5>
              </div>
              <div class="card-body">
                <p class="text-muted small">Control which features are visible in the user interface. Note: Backend modules must be installed for features to work.</p>

                <div class="row">
                  <div class="col-md-6 mb-3">
                    <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox" id="showMetadataTables" [checked]="formData().uiFeatures?.show_metadata_tables" (change)="updateUIFeature('show_metadata_tables', $any($event.target).checked)" [disabled]="!canEdit()">
                      <label class="form-check-label" for="showMetadataTables">
                        Show Metadata Tables
                      </label>
                    </div>
                  </div>

                  <div class="col-md-6 mb-3">
                    <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox" id="showInstruments" [checked]="formData().uiFeatures?.show_instruments" (change)="updateUIFeature('show_instruments', $any($event.target).checked)" [disabled]="!canEdit()">
                      <label class="form-check-label" for="showInstruments">
                        Show Instruments
                      </label>
                    </div>
                  </div>

                  <div class="col-md-6 mb-3">
                    <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox" id="showSessions" [checked]="formData().uiFeatures?.show_sessions" (change)="updateUIFeature('show_sessions', $any($event.target).checked)" [disabled]="!canEdit()">
                      <label class="form-check-label" for="showSessions">
                        Show Sessions
                      </label>
                    </div>
                  </div>

                  <div class="col-md-6 mb-3">
                    <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox" id="showProtocols" [checked]="formData().uiFeatures?.show_protocols" (change)="updateUIFeature('show_protocols', $any($event.target).checked)" [disabled]="!canEdit()">
                      <label class="form-check-label" for="showProtocols">
                        Show Protocols
                      </label>
                    </div>
                  </div>

                  <div class="col-md-6 mb-3">
                    <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox" id="showMessages" [checked]="formData().uiFeatures?.show_messages" (change)="updateUIFeature('show_messages', $any($event.target).checked)" [disabled]="!canEdit()">
                      <label class="form-check-label" for="showMessages">
                        Show Messages
                      </label>
                    </div>
                  </div>

                  <div class="col-md-6 mb-3">
                    <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox" id="showNotifications" [checked]="formData().uiFeatures?.show_notifications" (change)="updateUIFeature('show_notifications', $any($event.target).checked)" [disabled]="!canEdit()">
                      <label class="form-check-label" for="showNotifications">
                        Show Notifications
                      </label>
                    </div>
                  </div>

                  <div class="col-md-6 mb-3">
                    <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox" id="showStorage" [checked]="formData().uiFeatures?.show_storage" (change)="updateUIFeature('show_storage', $any($event.target).checked)" [disabled]="!canEdit()">
                      <label class="form-check-label" for="showStorage">
                        Show Storage
                      </label>
                    </div>
                  </div>

                  <div class="col-md-6 mb-3">
                    <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox" id="showWebrtc" [checked]="formData().uiFeatures?.show_webrtc" (change)="updateUIFeature('show_webrtc', $any($event.target).checked)" [disabled]="!canEdit()">
                      <label class="form-check-label" for="showWebrtc">
                        Show WebRTC
                      </label>
                    </div>
                  </div>

                  <div class="col-md-6 mb-3">
                    <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox" id="showBilling" [checked]="formData().uiFeatures?.show_billing" (change)="updateUIFeature('show_billing', $any($event.target).checked)" [disabled]="!canEdit()">
                      <label class="form-check-label" for="showBilling">
                        Show Billing
                      </label>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="col-lg-4">
            <div class="card">
              <div class="card-header">
                <h5 class="mb-0">Current Configuration</h5>
              </div>
              <div class="card-body">
                <dl class="row mb-0">
                  <dt class="col-sm-6">Site Name:</dt>
                  <dd class="col-sm-6">{{ config()?.siteName }}</dd>

                  <dt class="col-sm-6">Primary Color:</dt>
                  <dd class="col-sm-6">
                    <span class="badge" [style.background-color]="config()?.primaryColor">{{ config()?.primaryColor }}</span>
                  </dd>

                  <dt class="col-sm-6">Powered By:</dt>
                  <dd class="col-sm-6">
                    <span class="badge" [class.bg-success]="config()?.showPoweredBy" [class.bg-secondary]="!config()?.showPoweredBy">
                      {{ config()?.showPoweredBy ? 'Enabled' : 'Disabled' }}
                    </span>
                  </dd>

                  <dt class="col-sm-6">Registration:</dt>
                  <dd class="col-sm-6">
                    <span class="badge" [class.bg-success]="config()?.allowUserRegistration" [class.bg-secondary]="!config()?.allowUserRegistration">
                      {{ config()?.allowUserRegistration ? 'Enabled' : 'Disabled' }}
                    </span>
                  </dd>

                  <dt class="col-sm-6">ORCID Login:</dt>
                  <dd class="col-sm-6">
                    <span class="badge" [class.bg-success]="config()?.enableOrcidLogin" [class.bg-secondary]="!config()?.enableOrcidLogin">
                      {{ config()?.enableOrcidLogin ? 'Enabled' : 'Disabled' }}
                    </span>
                  </dd>

                  <dt class="col-sm-6">Deletion Window:</dt>
                  <dd class="col-sm-6">{{ config()?.bookingDeletionWindowMinutes }} min</dd>

                  <dt class="col-sm-6">Whisper Model:</dt>
                  <dd class="col-sm-6">
                    <small class="text-muted">{{ config()?.whisperCppModel || 'Not set' }}</small>
                  </dd>
                </dl>

                @if (config()?.updatedAt) {
                  <hr>
                  <div class="small text-muted">
                    <div>Last Updated:</div>
                    <div>{{ config()?.updatedAt | date: 'medium' }}</div>
                  </div>
                }
              </div>
            </div>

            @if (config()?.installedApps) {
              <div class="card mt-3">
                <div class="card-header">
                  <h5 class="mb-0">Installed Apps</h5>
                </div>
                <div class="card-body">
                  @if (config()?.installedApps && Object.keys(config()?.installedApps || {}).length > 0) {
                    <ul class="list-group list-group-flush">
                      @for (app of Object.values(config()?.installedApps || {}); track app.code) {
                        <li class="list-group-item px-0">
                          <div class="d-flex justify-content-between align-items-center">
                            <div>
                              <strong>{{ app.name }}</strong>
                              <div class="small text-muted">{{ app.description }}</div>
                            </div>
                            <span class="badge" [class.bg-success]="app.installed" [class.bg-secondary]="!app.installed">
                              {{ app.installed ? 'Active' : 'Inactive' }}
                            </span>
                          </div>
                        </li>
                      }
                    </ul>
                  } @else {
                    <p class="text-muted mb-0">No apps installed</p>
                  }
                </div>
              </div>
            }
          </div>
        </div>
      } @else {
        <div class="alert alert-warning">
          <i class="bi bi-exclamation-triangle me-2"></i>
          Unable to load site configuration. Please try refreshing the page.
        </div>
      }
  </div>
</div>
